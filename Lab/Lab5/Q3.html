<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers Multi-Layer Map</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* OpenLayers CSS */
        @import url("https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css");
        
        /* Custom Styles to make the map fill the screen */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent scrolling */
            font-family: 'Inter', sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
            transition: all 0.3s ease;
        }
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 200px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
            font-size: 1.2rem;
            color: #374151; /* Dark Gray */
        }
        .ol-popup-closer:after {
            content: "âœ–";
        }

    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <!-- Header and Controls -->
    <div class="p-4 bg-white shadow-lg z-10">
        <h1 class="text-xl font-bold text-gray-800">OpenLayers Map Viewer</h1>
        <div class="mt-2 flex flex-wrap gap-4 items-center">
            
            <!-- Basemap Selector -->
            <div class="flex items-center space-x-2">
                <label for="basemap-select" class="text-sm font-medium text-gray-700">Basemap:</label>
                <select id="basemap-select" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <option value="osm">OpenStreetMap</option>
                    <option value="esri">ESRI World Imagery</option>
                </select>
            </div>

            <!-- WMS Layer Toggle -->
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="wms-toggle" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <label for="wms-toggle" class="text-sm font-medium text-gray-700">WMS: Topp States</label>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map" class="flex-grow"></div>

    <!-- OpenLayers Popup Container -->
    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>

    <!-- OpenLayers Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <script>
        // Use a self-invoking function to manage scope and ensure execution after DOM load
        window.onload = function() {
            // --- 1. SETUP FIREBASE GLOBALS (Not strictly needed for OpenLayers, but good practice for Canvas environment) ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            // No Firebase initialization is needed since this is purely a mapping application.

            // --- 2. OPENLAYERS IMPORTS AND INITIALIZATION ---
            
            // Destructure necessary modules from the global ol object
            const { Map, View } = ol;
            const { Tile, WebGLTile } = ol.layer;
            const { OSM, XYZ, TileWMS } = ol.source;
            const { fromLonLat, toLonLat } = ol.proj;
            const { Overlay } = ol;

            // Define the center of the initial map view (e.g., USA center)
            const initialCenter = fromLonLat([-98.5795, 39.8283]); // Geographic coordinates for roughly the center of the US

            // --- 3. LAYER DEFINITIONS ---

            // OpenStreetMap Basemap Layer
            const osmLayer = new Tile({
                title: 'OpenStreetMap',
                type: 'base',
                visible: true,
                source: new OSM(),
            });

            // ESRI World Imagery Basemap Layer (using XYZ source)
            const esriImageryLayer = new Tile({
                title: 'ESRI World Imagery',
                type: 'base',
                visible: false, // Start hidden
                source: new XYZ({
                    attributions:
                        'Tiles &copy; <a href="https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer">ESRI</a>',
                    url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    maxZoom: 19,
                }),
            });

            // WMS Overlay Layer: topp:states
            // Note: The WMS URL parameters are slightly cleaner when defined in the source object
            const wmsLayer = new Tile({
                title: 'WMS Topp States',
                visible: true, // Start visible
                opacity: 0.5, // Make it semi-transparent
                source: new TileWMS({
                    url: 'https://ahocevar.com/geoserver/wms',
                    params: {
                        'LAYERS': 'topp:states',
                        'TILED': true,
                        // Note: The SRS is typically derived from the map's projection (EPSG:3857)
                        // but setting it explicitly can be done if needed, though for standard
                        // WMS services, leaving it out lets OL handle the reprojection request.
                    },
                    serverType: 'geoserver',
                    // This service is in EPSG:4326, but OL handles the projection change to 3857 for display.
                }),
            });
            
            // --- 4. MAP INITIALIZATION ---

            const map = new Map({
                target: 'map',
                layers: [
                    osmLayer,          // Basemap 1 (Default visible)
                    esriImageryLayer,  // Basemap 2
                    wmsLayer           // Overlay Layer
                ],
                view: new View({
                    center: initialCenter,
                    zoom: 4, // Zoomed out view of the US
                    minZoom: 2,
                    maxZoom: 20
                }),
            });

            // --- 5. INTERACTIVITY: POPUP FOR WMS ATTRIBUTES ---
            
            // Get the popup elements
            const container = document.getElementById('popup');
            const content = document.getElementById('popup-content');
            const closer = document.getElementById('popup-closer');

            // Create the Overlay object for the popup
            const popup = new Overlay({
                element: container,
                autoPan: {
                    animation: {
                        duration: 250,
                    },
                },
            });
            map.addOverlay(popup);

            // Close the popup when the close button is clicked
            closer.onclick = function () {
                popup.setPosition(undefined);
                closer.blur();
                return false;
            };

            // Add map click handler to query WMS features (GetFeatureInfo)
            map.on('singleclick', function (evt) {
                if (wmsLayer.getVisible() === false) {
                    // Only query WMS if the layer is visible
                    return;
                }

                const viewResolution = map.getView().getResolution();
                const url = wmsLayer.getSource().getFeatureInfoUrl(
                    evt.coordinate,
                    viewResolution,
                    'EPSG:3857', // Map's projection
                    {'INFO_FORMAT': 'application/json'} // Request JSON format
                );

                if (url) {
                    fetch(url)
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.features.length > 0) {
                                // Extract properties from the first feature
                                const properties = data.features[0].properties;
                                
                                // Format the content
                                let html = `<h4 class="font-bold text-lg mb-1">${properties.STATE_NAME || 'Feature Info'}</h4>`;
                                html += `<ul class="text-sm space-y-0.5">`;
                                
                                // List the key properties (customize this list based on what you want to show)
                                const keysToShow = ['STATE_FIPS', 'SUB_REGION', 'AREA_SQKM'];
                                keysToShow.forEach(key => {
                                    if (properties.hasOwnProperty(key)) {
                                        let value = properties[key];
                                        if (key === 'AREA_SQKM') {
                                            value = parseFloat(value).toFixed(2) + ' sq. km';
                                        }
                                        html += `<li><span class="font-semibold">${key.replace('_', ' ')}:</span> ${value}</li>`;
                                    }
                                });

                                html += `</ul>`;

                                content.innerHTML = html;
                                popup.setPosition(evt.coordinate);
                            } else {
                                content.innerHTML = '<p class="text-gray-500">No feature found at this location.</p>';
                                popup.setPosition(evt.coordinate);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching WMS feature info:', error);
                            content.innerHTML = '<p class="text-red-500">Error querying WMS data.</p>';
                            popup.setPosition(evt.coordinate);
                        });
                }
            });

            // --- 6. CONTROL EVENT LISTENERS ---

            // Basemap Switcher Logic
            document.getElementById('basemap-select').addEventListener('change', (event) => {
                const selectedBasemap = event.target.value;
                if (selectedBasemap === 'osm') {
                    osmLayer.setVisible(true);
                    esriImageryLayer.setVisible(false);
                } else if (selectedBasemap === 'esri') {
                    osmLayer.setVisible(false);
                    esriImageryLayer.setVisible(true);
                }
            });

            // WMS Layer Toggle Logic
            document.getElementById('wms-toggle').addEventListener('change', (event) => {
                wmsLayer.setVisible(event.target.checked);
                // Hide the popup if the WMS layer is turned off
                if (!event.target.checked) {
                    popup.setPosition(undefined);
                }
            });

            // Log successful initialization
            console.log("OpenLayers map successfully initialized.");
        };
    </script>
</body>
</html>
